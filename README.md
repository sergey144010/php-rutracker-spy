php-rutracker-spy
==========================

Version 0.0.5

Краткое описание
-------
Программа просматривает разделы форума rutracker.
В соответствии с установленным фильтром скачивает торрент файлы
и добавляет запись в базу данных.

Для чего?
-------
Далее настраиваете торрент клиент на скачивание новых торрентов из определенной папки
(в нашем случае из папки torrent) и получаете автоматическое скачивание новых торрентов с RuTracker.

Описание
-------
Программа логинится на rutracker. Сохраняет куки.
Открывает страницу. Парсит страницу получает темы.
Если темы проходят фильтр скачивает торрент файл и добавляет запись в базу данных.
При повторном заходе используются сохраненные куки.
Если темы проходят фильтр и они уже есть базе, то сверяется размер торрента.
И только торрент с большим размером файла будет заново скачан.

Зависимости
-------
Необходим установленный сервер баз данных, поддерживаеммый в yii2.
По умолчанию используется - MySql.
(PHP, sunra/php-simple-html-dom-parser)

Установка
-------
Клонировать репозиторий.
```php
git clone https://github.com/sergey144010/php-rutracker-spy YOUR_PATH
```
Перейти в YOUR_PATH.
Установить зависимости командой
```php
composer update
```

Настройка
-------

Создать конфиг, запустив скрипт create_config.php
```php
php create_config.php
```

В созданном файле конфига config.php заполнить
настройки для подключения к базе данных
```php
    "db" =>
        [
            // Класс для работы с базой данных
            # Можно создать свой класс в соответствии с DbInterface
            # и подключить его здесь
            "class"=>"sergey144010\RutrackerSpy\DbYii",
            // Сервер базы данных
            "type"=>"mysql",
            // Хост базы данных
            "host"=>"localhost",
            // Имя базы данных
            "name"=>"rutracker_spy",
            // Имя пользователя и пароль для доступа к базе данных
            "user"=>"userName",
            "pass"=>"password",
        ],
```
Создать соответствующую базу данных в MySql. В нашем случае rutracker_spy.

Заполнить имя пользователя и пароль для входа на Rutracker.
```php
    "client" =>
        [
            "user"=>"login",
            "pass"=>"password",
        ],
```

Остальные настройки можно оставить как есть за исключением фильтра тем.

Для режима сервиса можно изменить промежуток времени запуска в секундах
```php
    "timer" =>
        [
            "time"=>"3600",
        ]
```

Создать недостающие директории cookie, log, themeSpy, torrent, web/assets
запустив скрипт
```php
php create_dir.php
```
Все директории и файлы берутся из конфига.

И собственно добавить отслеживаемые темы.
По умолчанию файл отслеживаемых тем  - themeSpy/theme.txt
Заполнить его, формат следующий: новая строка = новый раздел
```php
http://rutracker.org/forum/viewforum.php?f=2200
http://rutracker.org/forum/viewforum.php?f=2093
```

Настройка фильтра тем
---------------------

Отключение фильтра в файле конфига config.php
```php
    "filtr" =>
        [
            // on - включен, off - выключен
            "turn"=>"off",
        ],
```
При отключенном фильтре все темы будут скачаны.

Настройка фильтра:
```php
    "filtr" =>
        [
            // Класс фильтра
            "class"=>"sergey144010\RutrackerSpy\Filtr",
            // Включить/выключить фильтр - on/off
            "turn"=>"on",
            // Для каждого раздела свой фильтр
            // Включить/выключить - on/off
            "manyFiltr"=>"off",
            // Настройки фильтрации.
            // Если не нужно можно оставить пустым, например: "setting"=>""
            "setting"=>
                // Если какой-либо фильтр не нужен, то
                // можно его удалить или оставить пустое значение.
                // Например:
                // "genre"=>"", "quality"=>"", "size"=>"", "stopWord"=>"", "seed"=>"", "travelCard"=>""
                // При настройках ниже получается следующее:
                // Скачивать если тема содержит или "комедия" или "семейный" или "приключения",
                // но не содержит "ужасы".
                // Качество любое кроме CAMRip,
                // Размер от 1Gb до 3Gb,
                // Минимальное количество сидов 1 шт.
                [
                    // Жанр
                    "genre"=>
                        [
                            // Если нужно скачать все кроме ужасов
                            // параметр only комментируем или оставляем пустым.
                            #"only"=>["комедия", "семейный", "приключения"],
                            //
                            // Если нужно скачать только "комедия", "семейный", "приключения"
                            // параметр exept комментируем или оставляем пустым.
                            #"exept"=>["ужасы"],
                            //
                            // Если нужно скачать только "комедия", "семейный", "приключения"
                            // в которых не присутствует "ужасы"
                            // используем оба параметра.
                            //
                            // В данном случае если в описании присутствуют [комедия, ужасы]
                            // фильм скачан не будет.

                            // Качать только ...
                            "only"=>["комедия", "семейный", "приключения"],
                            // Качать все кроме ...
                            "exept"=>["ужасы"],
                        ],

                    // Качество
                    "quality"=>
                        [
                            // Здесь фильтр работает не так как в жанре, в данном случае
                            // приоритет only выше exept, комментируем "only" или удаляем
                            // Оба правила взаимоисключающие, вместе не работают.
                            // Качать только ...
                            #"only"=>["HDRip", "DVDRip" ,"WEB-DLRip" , "BDRip"],
                            // Качать все кроме ...
                            "exept"=>["CAMRip"],
                        ],

                    // Размер
                    "size"=>
                        [
                            // Варианты:
                            // Если размер от 1 GB - "min"=>"1Gb",
                            // закомментировать "max"=>"3Gb"
                            //
                            // Если размер до 2 GB - "max"=>"2Gb",
                            // закомментировать "min"=>"1Gb"
                            //
                            // Если размер от 1 GB до 2 GB
                            // использовать оба параметра
                            "min"=>"1Gb",
                            "max"=>"3Gb",
                            // Скачивать или не скачивать
                            // файл с большим размером в пределах от min до max
                            // если такой уже есть в базе.
                            // "off" - не скачивать, "on" - скачивать
                            "downloadBigger"=>"off",
                        ],

                    // Стоповое слово ( или массив из нескольких слов )
                    // Если найдено не качать
                    // Например: фамилия НЕ любимого актёра
                    "stopWord"=>[""],

                    // Сиды
                    "seed"=>
                        [
                            // Минимально необходимое количество сидов
                            "min"=>"1",
                        ],

                    // Проездной
                    // Если найдено качать в любом случае
                    // Например: фамилия любимого актёра
                    "travelCard"=>[""],
                ],
        ],
```

Если мы хотим для каждого раздела установить свои фильтры, то нужно
в файле конфига config.php включить опцию
```php
"manyFiltr"=>"on",
```
Далее необходимо создать сами фильтры следующей коммандой:

Вариант №1.
```php
php create_theme_config.php
```
В данном случае в директории отслеживаемых тем, по умолчанию themeSpy,
появится один файл вида 1458574015.filtr.php со следующим содержимым, которое необходимо заполнить

```php
$filtr =
[
    // URL раздела
    // Например:
    // http://rutracker.org/forum/viewforum.php?f=2200
    "url" => "",
    
    // Глубина просмотра темы
    // "entry" => "0", - смотрим только первую страницу раздела
    // "entry" => "1", - смотрим первую и вторую страницы раздела
    // "entry" => "2", - смотрим 1,2,3 страницы раздела
    // "entry" => "all", - смотрим все страницы раздела
    "entry" => "0",

    // Настройки фильтрации.
    // Если не нужно можно оставить пустым, например: "setting"=>""
    "setting"=>
    // Если какой-либо фильтр не нужен, то
    // можно его удалить или оставить пустое значение.
    // Например:
    // "genre"=>"", "quality"=>"", "size"=>"", "stopWord"=>"", "seed"=>"", "travelCard"=>""
    // При настройках ниже получается следующее:
    // Скачивать если тема содержит или "комедия" или "семейный" или "приключения",
    // но не содержит "ужасы".
    // Качество любое кроме CAMRip,
    // Размер от 1Gb до 3Gb,
    // Минимальное количество сидов 1 шт.
        [
            // Жанр
            "genre"=>
                [
                    // Если нужно скачать все кроме ужасов
                    // параметр only комментируем или оставляем пустым.
                    #"only"=>["комедия", "семейный", "приключения"],
                    //
                    // Если нужно скачать только "комедия", "семейный", "приключения"
                    // параметр exept комментируем или оставляем пустым.
                    #"exept"=>["ужасы"],
                    //
                    // Если нужно скачать только "комедия", "семейный", "приключения"
                    // в которых не присутствует "ужасы"
                    // используем оба параметра.
                    //
                    // В данном случае если в описании присутствуют [комедия, ужасы]
                    // фильм скачан не будет.

                    // Качать только ...
                    "only"=>["комедия", "семейный", "приключения"],
                    // Качать все кроме ...
                    "exept"=>["ужасы"],
                ],

                // Качество
                "quality"=>
                    [
                    // Здесь фильтр работает не так как в жанре, в данном случае
                    // приоритет only выше exept, комментируем "only" или удаляем
                    // Оба правила взаимоисключающие, вместе не работают.
                    // Качать только ...
                    #"only"=>["HDRip", "DVDRip" ,"WEB-DLRip" , "BDRip"],
                    // Качать все кроме ...
                        "exept"=>["CAMRip"],
                    ],

                // Размер
                "size"=>
                    [
                        // Варианты:
                        // Если размер от 1 GB - "min"=>"1Gb",
                        // закомментировать "max"=>"3Gb"
                        //
                        // Если размер до 2 GB - "max"=>"2Gb",
                        // закомментировать "min"=>"1Gb"
                        //
                        // Если размер от 1 GB до 2 GB
                        // использовать оба параметра
                        "min"=>"1Gb",
                        "max"=>"3Gb",
                        // Скачивать или не скачивать
                        // файл с большим размером в пределах от min до max
                        // если такой уже есть в базе.
                        // "off" - не скачивать, "on" - скачивать
                        "downloadBigger"=>"off",
                    ],

                // Стоповое слово ( или массив из нескольких слов )
                // Если найдено не качать
                // Например: фамилия НЕ любимого актёра
                "stopWord"=>[""],

                // Сиды
                "seed"=>
                    [
                         // Минимально необходимое количество сидов
                        "min"=>"1",
                    ],

                // Проездной
                // Если найдено качать в любом случае
                // Например: фамилия любимого актёра
                "travelCard"=>[""],
        ],
    // Данная опция является
    // шаблоном разбора названия топиков в данном разделе.
    // Возвращает уникальное название для последующей работы с базой данных (поиск в базе данных по хешу данного названия).
    // При помощи неё указывается как разбирать название топика.
    // По умолчанию она отключена и используется разбор как показан ниже, он применим для строки типа:
    // "Дэдпул / Deadpool (Тим Миллер / Tim Miller) [2016, США, Фантастика, боевик, комедия, приключения, WEBRip] Dub (Line)"
    // Здесь выделяется слово "Дэдпул" и по нему уже идет последующий поиск в базе данных.
    /*
    "extraction" => function($string){
        $array = explode("/", $string, 2);
        $name = $array[0];
        $name = trim($name);
        return $name;
    },
    */
    // Например для строк типа
    // "Уроки выживания (Андрей Томашевский) [2016, комедия, семейный, приключения, WEB-DLRip]"
    // можно использовать следующую функцию обратного вызова
    /*
    "extraction" => function($string){
        // Шаблон регулярного выражения
        $reg = "/.*\(/i";
        // Поиск по регулярному выражению
        preg_match($reg, $string, $matches);
        // Если нашли выделенную часть
        if(isset($matches[0])){
            // Отрезаем скобку с конца
            $name = substr($matches[0], 0 , -1);
            // Удаляем пробелы с начала и конца
            $name = trim($name);
            // Возвращаем название
            return $name;
        };
        // Если не нашли выделенную часть,
        // то устанавливаем всю строку в качестве выделенной части (названия).
        // Удаляем пробелы с начала и конца
        $string = trim($string);
        return $string;
    },
    */
    // Данная опция является функцией обратного вызова и
    // принимает строку $string (название топика).
    // Она должна возвращать выделенное имя (return $name) или false (return false);
];
```

Вариант №2.
```php
php create_theme_config.php 5
```
В данном случае в директории отслеживаемых тем, по умолчанию themeSpy,
появятся пять файлов вида 1458574015.filtr.php

Вариант №3.
```php
php create_theme_config.php 1 NameTopic
```
В данном случае в директории отслеживаемых тем, по умолчанию themeSpy,
появится файл вида NameTopic.filtr.php
Здесь даже если вы вместо 1 напишите 11, то всё равно будет создан один файл с
именем NameTopic.filtr.php. Главное не пропустить данный параметр.

Пример
------
Имеется два раздела.
Раздел раз - http://rutracker.org/forum/viewforum.php?f=2093
Раздел два - http://rutracker.org/forum/viewforum.php?f=22
В первом разделе названия тем имеют шаблон.
```php
"Звёздные войны: Пробуждение силы / Star Wars: Episode VII - The Force Awakens (Джей Джей Абрамс / J.J. Abrams) [2015, США, Фантастика, фэнтези, боевик, приключения, BDRip] [Локализованный видеоряд] Dub + Sub"
```
Во втором разделе названия тем имеют шаблон
```php
"Дикари (Виктор Шамиров) [2006, драма, мелодрама, комедия, DVDRip]"
```
Для корректой работы программы с базой данных, нужно выделить из названия тем оригинальное
название (для поиска в базе данных). В данном случае за оригинальное название принимаем название на русском языке,
т.е. в первом случае это - "Звёздные войны: Пробуждение силы",
а во втором случае это - "Дикари".
Для этого создаем для каждого раздела свой фильтр, следующей коммандой
```php
php create_theme_config.php 1 Cinema-2011-2015
php create_theme_config.php 1 Cinema-Rus
```
Правим файл фильтра Cinema-2011-2015.filtr.php следующим образом
```php
<?php
$filtr =
    [
        "url" => "http://rutracker.org/forum/viewforum.php?f=2093",
        "entry" => "3",
        "setting" =>
            [
                "genre"=>
                    [
                        "only"=>["комедия", "семейный", "приключения"],
                        "exept"=>["ужасы", "триллер"],
                    ],
                "quality"=>
                    [
                        #"only"=>["HDRip", "DVDRip" ,"WEB-DLRip" , "BDRip"],
                        "exept"=>["CAMRip", "WEBRip"],
                    ],
                "size"=>
                    [
                        "min"=>"1Gb",
                        "max"=>"3Gb",
                        "downloadBigger"=>"off",
                    ],
                "stopWord"=>[""],
                "seed"=>
                    [
                        "min"=>"1",
                    ],
                "travelCard"=>[""],
            ],
        "extraction" => function($string){
            $array = explode("/", $string, 2);
            $name = $array[0];
            $name = trim($name);
            return $name;
        },
    ];
```
Правим файл фильтра Cinema-Rus.filtr.php следующим образом
```php
<?php
$filtr =
[
    "url" => "http://rutracker.org/forum/viewforum.php?f=22",
    "entry" => "1",
    "setting"=>
        [
            "genre"=>
                [
                    "only"=>["комедия", "семейный", "приключения"],
                    "exept"=>["ужасы", "триллер"],
                ],
                "quality"=>
                    [
                        "exept"=>["CAMRip", "WEBRip"],
                    ],
                "size"=>
                    [
                        "min"=>"1Gb",
                        "max"=>"3Gb",
                        "downloadBigger"=>"off",
                    ],
                "stopWord"=>[""],
                "seed"=>
                    [
                        "min"=>"1",
                    ],
                "travelCard"=>[""],
        ],
    "extraction" => function($string){
        // Шаблон регулярного выражения
        $reg = "/.*\(/i";
        // Поиск по регулярному выражению
        preg_match($reg, $string, $matches);
        // Если нашли выделенную часть
        if(isset($matches[0])){
            // Отрезаем скобку с конца
            $name = substr($matches[0], 0 , -1);
            // Удаляем пробелы
            $name = trim($name);
            // Возвращаем название
            return $name;
        };
        // Если не нашли выделенную часть,
        // то устанавливаем всю строку в качестве выделенной части (названия).
        return $string;
    },
];
```
В основном файле конфига config.php включаем опцию
```php
"manyFiltr"=>"on",
```
Настройка закончена. Можно запускать программу.
```php
php run_once.php
```

Зачем выделять оригинальное название?
Название шифруется и добавляется в базу данных.
Для облегчения поиска по базе данных в процессе работы программы.

Web
---
Просмотреть, что скачалось возможно через браузер - web/index.php

Использование
-------

Однократный запуск
-------
```php
php run_once.php
```
или в Windows просто
```php
run_once.cmd
```

Многократный запуск
-------
```php
php run_service.php
```
или в Windows просто
```php
run_service.cmd
```

В режиме сервиса
-------
Для *nix
Добавить в сервисы run_service.php

Для Windows
Скачиваем программу http://nssm.cc/usage
Устанавливаем сервис
```php
nssm.exe install RuTrackerSpy "путь до run_service.cmd"
```
Например:
```php
nssm.exe install RuTrackerSpy "C:\RutrackerSpy\run_service.cmd"
```

Добавлено
-----------------
1. Прикреплен yii2 фреймворк.
2. Дописан новый класс работы с базой данных на основе yii2.
3. Добавлен веб интерфейс на основе yii2.
4. Добавлена возможность парсинга страниц раздела.


Что нужно исправить/добавить
----------------------------

1. Отвязаться от nameRusHash.