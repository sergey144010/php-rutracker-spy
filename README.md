php-rutracker-spy
==========================

Version 0.0.1

Краткое описание
-------
Программа просматривает разделы форума rutracker.
В соответствии с установленным фильтром скачивает торрент файлы
и добавляет запись в базу данных.

Для чего?
-------
Далее настраиваете торрент клиент на скачивание новых торрентов из определенной папки
(в нашем случае из папки torrent) и получаете автоматическое скачивание новых торрентов с RuTracker.

Описание
-------
Программа логинится на rutracker. Сохраняет куки.
Открывает страницу. Парсит страницу получает темы.
Если темы проходят фильтр скачивает торрент файл и добавляет запись в базу данных.
При повторном заходе используются сохраненные куки.
Если темы проходят фильтр и они уже есть базе, то сверяется размер торрента.
И только торрент с большим размером файла будет заново скачан.

Зависимости
-------
Необходим установленный сервер баз данных - MySql.
(PHP, sunra/php-simple-html-dom-parser)

Установка
-------
Клонировать репозиторий.
```php
git clone https://github.com/sergey144010/php-rutracker-spy YOUR_PATH
```
Перейти в YOUR_PATH.
Установить зависимости командой
```php
composer update
```

Настройка
-------

Создать конфиг, запустив скрипт create_config.php
```php
php create_config.php
```

В созданном файле конфига config.php заполнить
настройки для подключения к базе данных
```php
    "db" =>
        [
            // Класс для работы с базой данных
            # Можно создать свой класс в соответствии с DbInterface
            # и подключить его здесь
            "class"=>"sergey144010\RutrackerSpy\Db",
            // Сервер базы данных
            "type"=>"mysql",
            // Хост базы данных
            "host"=>"localhost",
            // Имя базы данных
            "name"=>"rutracker_spy",
            // Имя пользователя и пароль для доступа к базе данных
            "user"=>"userName",
            "pass"=>"password",
        ],
```
Создать соответствующую базу данных в MySql. В нашем случае rutracker_spy.

Заполнить имя пользователя и пароль для входа на Rutracker.
```php
    "client" =>
        [
            "user"=>"login",
            "pass"=>"password",
        ],
```

Остальные настройки можно оставить как есть за исключением фильтра тем.

Для режима сервиса можно изменить промежуток времени запуска в секундах
```php
    "timer" =>
        [
            "time"=>"3600",
        ]
```

Создать недостающие директории cookie, log, themeSpy, torrent
запустив скрипт
```php
php create_dir.php
```
Все директории и файлы берутся из конфига.

И собственно добавить отслеживаемые темы.
По умолчанию файл отслеживаемых тем  - themeSpy/theme.txt
Заполнить его, формат следующий: новая строка = новый раздел
```php
http://rutracker.org/forum/viewforum.php?f=2200
http://rutracker.org/forum/viewforum.php?f=2093
```

Настройка фильтра тем
---------------------

Отключение фильтра в файле конфига config.php
```php
    "filtr" =>
        [
            // on - включен, off - выключен
            "turn"=>"off",
        ],
```
При отключенном фильтре все темы будут скачаны.

Настройка фильтра:
```php
    "filtr" =>
        [
            // Класс фильтра
            "class"=>"sergey144010\RutrackerSpy\Filtr",
            // Включить/выключить фильтр - on/off
            "turn"=>"on",
            // Настройки фильтрации.
            // Если не нужно можно оставить пустым, например: "setting"=>""
            "setting"=>
                // Если какой-либо фильтр не нужен, то
                // можно его удалить или оставить пустое значение.
                // Например:
                // "genre"=>"", "quality"=>"", "size"=>"", "stopWord"=>"", "seed"=>"", "travelCard"=>""
                // При настройках ниже получается следующее:
                // Скачивать если тема или "комедия" или "семейный" или "приключения",
                // Качество любое кроме CAMRip,
                // Размер от 1Gb до 3Gb,
                // Минимальное количество сидов 1 шт.
                [
                    // Жанр
                    "genre"=>
                        [
                            // Качать только ...
                            // Приоритет only выше exept
                            "only"=>["комедия", "семейный", "приключения"],
                            // Качать все кроме ...
                            // Здесь "exept" не отработает, можно не комментировать, также можно удалить
                            "exept"=>["триллер"],
                        ],
                    
                    // Качество
                    "quality"=>
                        [
                            // Качать только ...
                            // Приоритет only выше exept, комментируем "only" или удаляем
                            #"only"=>["HDRip", "DVDRip" ,"WEB-DLRip" , "BDRip"],
                            // Качать все кроме ...
                            "exept"=>["CAMRip"],
                        ],
                    
                    // Размер
                    "size"=>
                        [
                            // Варианты:
                            // размер от 1 GB
                            // размер до 2 GB
                            // размер от 1 GB до 2 GB
                            "min"=>"1Gb",
                            "max"=>"3Gb",
                        ],
                    
                    // Стоповое слово ( или массив из нескольких слов )
                    // Если найдено не качать
                    // Например: фамилия НЕ любимого актёра
                    "stopWord"=>[""],
                    
                    // Сиды
                    "seed"=>
                        [
                            // Минимально необходимое количество сидов
                            "min"=>"1",
                        ],

                    // Проездной
                    // Если найдено качать в любом случае
                    // Например: фамилия любимого актёра
                    "travelCard"=>[""],
                ],
        ],
```

Использование
-------

Однократный запуск
-------
```php
php run_once.php
```
или в Windows просто
```php
run_once.cmd
```

Многократный запуск
-------
```php
php run_service.php
```
или в Windows просто
```php
run_service.cmd
```

В режиме сервиса
-------
Для *nix
Добавить в сервисы run_service.php

Для Windows
Скачиваем программу http://nssm.cc/usage
Устанавливаем сервис
```php
nssm.exe install RuTrackerSpy "путь до run_service.cmd"
```
Например:
```php
nssm.exe install RuTrackerSpy "C:\RutrackerSpy\run_service.cmd"
```

Что нужно исправить/добавить
----------------------------

1. Фильтр для каждой темы/группы тем.
2. Переписать класс работы с базой данных.
3. Отвязаться от nameRusHash.
4. Придумать что-то с web.